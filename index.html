<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>HyperGame</title>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background: #000;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #game-container {
            width: 100%;
            height: 100%;
            display: none; /* Começa escondido */
        }
        canvas {
            display: block;
            width: 100%;
            height: 100%;
        }
        #start-message {
            position: absolute;
            top: 0; left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2em;
            font-family: Arial, sans-serif;
            z-index: 100;
            cursor: pointer;
        }
        /* --- ESTILOS DO JOYSTICK --- */
        .joystick-container {
            display: none; /* Escondido por padrão */
            position: absolute;
            bottom: 20px;
            left: 0;
            width: 100%;
            z-index: 20;
            justify-content: space-between;
            padding: 0 30px;
            box-sizing: border-box;
        }
        .joy-btn {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            border: 2px solid white;
            background: rgba(128, 128, 128, 0.5);
            color: white;
            font-size: 2em;
            user-select: none;
            -webkit-user-select: none;
        }
        .joystick-arrows, .joystick-action {
            display: flex;
            gap: 20px;
        }
        @media (pointer: coarse) {
            .joystick-container {
                display: flex;
            }
        }
    </style>
</head>
<body>
    <div id="game-container">
        <canvas id="platformer-canvas"></canvas>
    </div>
    <div id="start-message">Toque para Iniciar</div>
    <!-- --- HTML DO JOYSTICK --- -->
    <div id="joystick" class="joystick-container">
        <div class="joystick-arrows">
            <button id="joy-left" class="joy-btn">◀</button>
            <button id="joy-right" class="joy-btn">▶</button>
        </div>
        <div class="joystick-action">
            <button id="joy-up" class="joy-btn">▲</button>
        </div>
    </div>

    <script>
        window.onload = function() {
            const startMessage = document.getElementById('start-message');
            const gameContainer = document.getElementById('game-container');
            let gameInitialized = false;

            function initGame() {
                if (gameInitialized) return;
                gameInitialized = true;

                startMessage.style.display = 'none';
                gameContainer.style.display = 'block';
                
                // Tenta esconder a barra de endereço em mobile
                setTimeout(() => window.scrollTo(0, 1), 100);

                startGame();
            }

            // Inicia o jogo com um único toque ou clique
            document.body.addEventListener('click', initGame, { once: true });
            document.body.addEventListener('touchstart', initGame, { once: true });
        };

        function startGame() {
            const canvas = document.getElementById('platformer-canvas');
            const ctx = canvas.getContext('2d');
            
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;

            // --- ESTADO GERAL DO JOGO ---
            let score = 0;
            let stage = 1;
            let lives = 3;
            let gameState = 'platformer'; // 'platformer', 'shooter', ou 'win'
            const groundHeight = 70;

            // --- ASSETS ---
            const playerImage = new Image();
            playerImage.src = 'Sprites/personagem.png';
            const rocketImage = new Image();
            rocketImage.src = 'Sprites/foguete.png';
            const enemyImage = new Image();
            enemyImage.src = 'Sprites/inimigo.png';

            // --- OBJETOS DO JOGO ---
            const player = {
                x: 100, y: canvas.height - groundHeight - 100,
                width: 100, height: 100, speed: 6,
                dy: 0, gravity: 0.5,
                jumpPower: -17, onGround: true
            };
            const rocket = {
                x: canvas.width / 2 - 50, y: canvas.height - 120,
                width: 100, height: 100, speed: 8
            };
            let platforms = [], coins = [], enemies = [], rocks = [], bullets = [];
            let shootCooldown = 0, rocksToDestroy = 0, rocksDestroyed = 0;

            // --- FUNÇÕES DE CONTROLE DE JOGO ---
            function handleDeath() {
                lives--;
                if (lives <= 0) {
                    alert("Game Over! Reiniciando do começo.");
                    stage = 1;
                    score = 0;
                    lives = 3;
                    gameState = 'platformer';
                    generatePlatformerLevel();
                } else {
                    if (gameState === 'platformer') restartPlatformerLevel();
                    else initializeShooterLevel();
                }
            }

            function advanceStage() {
                stage++;
                if (stage > 20) {
                    gameState = 'win';
                    return;
                }
                if (stage === 5) initializeShooterLevel();
                else { gameState = 'platformer'; generatePlatformerLevel(); }
            }

            // --- FUNÇÕES DE GERAÇÃO DE NÍVEL ---
            function generatePlatformerLevel() {
                platforms = [], coins = [], enemies = [];
                player.x = 100;
                player.y = canvas.height - groundHeight - player.height;
                const platformCount = 6 + Math.min(stage, 5);
                let lastPlatform = { x: 50, y: canvas.height - groundHeight - 80, width: 150 };

                for (let i = 0; i < platformCount; i++) {
                    const platWidth = 120, platHeight = 20;
                    const horizontalDist = 100 + Math.random() * 150;
                    const verticalDist = -50 - Math.random() * 80;
                    let newX = lastPlatform.x + lastPlatform.width / 2 + horizontalDist;
                    let newY = lastPlatform.y + verticalDist;

                    if (newX + platWidth > canvas.width - 50) newX = lastPlatform.x - horizontalDist - platWidth;
                    if (newY < 100) newY = 100;
                    if (newY > canvas.height - groundHeight - 50) newY = canvas.height - groundHeight - 50;

                    const newPlatform = { x: newX, y: newY, width: platWidth, height: platHeight };
                    platforms.push(newPlatform);
                    coins.push({ x: newX + platWidth / 2 - 7.5, y: newY - 30, size: 15, collected: false });

                    if (stage >= 6 && Math.random() > 0.4) {
                        const enemyX = newPlatform.x + newPlatform.width / 2 - 15;
                        enemies.push({ x: enemyX, y: newPlatform.y - 30, width: 30, height: 30, alive: true, speed: 0.8, direction: 1, patrolRange: 40, startX: enemyX });
                    }
                    lastPlatform = newPlatform;
                }
            }
            
            function restartPlatformerLevel() {
                player.x = 100;
                player.y = canvas.height - groundHeight - player.height;
                player.dy = 0;
                enemies.forEach(e => { e.alive = true; e.x = e.startX; });
                coins.forEach(c => c.collected = false);
            }

            function initializeShooterLevel() {
                gameState = 'shooter';
                rocks = [], bullets = [];
                rocksDestroyed = 0;
                rocksToDestroy = 20;
                rocket.x = canvas.width / 2 - rocket.width / 2;
            }

            // --- CONTROLES (TECLADO E JOYSTICK) ---
            const keys = { left: false, right: false, up: false };
            
            document.addEventListener('keydown', e => {
                if (e.key === 'ArrowLeft') keys.left = true;
                if (e.key === 'ArrowRight') keys.right = true;
                if (e.key === 'ArrowUp') keys.up = true;
            });
            document.addEventListener('keyup', e => {
                if (e.key === 'ArrowLeft') keys.left = false;
                if (e.key === 'ArrowRight') keys.right = false;
                if (e.key === 'ArrowUp') keys.up = false;
            });

            const joyLeft = document.getElementById('joy-left');
            const joyRight = document.getElementById('joy-right');
            const joyUp = document.getElementById('joy-up');

            function setupJoyButton(btn, key) {
                btn.addEventListener('touchstart', (e) => { e.preventDefault(); keys[key] = true; }, { passive: false });
                btn.addEventListener('touchend', (e) => { e.preventDefault(); keys[key] = false; }, { passive: false });
                btn.addEventListener('mousedown', (e) => { e.preventDefault(); keys[key] = true; });
                btn.addEventListener('mouseup', (e) => { e.preventDefault(); keys[key] = false; });
                btn.addEventListener('mouseleave', (e) => { keys[key] = false; });
            }

            setupJoyButton(joyLeft, 'left');
            setupJoyButton(joyRight, 'right');
            setupJoyButton(joyUp, 'up');

            // --- LÓGICAS DE UPDATE ---
            function updatePlatformer() {
                if (keys.left) player.x -= player.speed;
                if (keys.right) player.x += player.speed;
                if (keys.up && player.onGround) { player.dy = player.jumpPower; player.onGround = false; }

                player.dy += player.gravity;
                player.y += player.dy;
                player.onGround = false;

                if (player.y + player.height > canvas.height - groundHeight) { player.y = canvas.height - groundHeight - player.height; player.dy = 0; player.onGround = true; }

                platforms.forEach(platform => {
                    if (player.dy >= 0 && player.x < platform.x + platform.width && player.x + player.width > platform.x && player.y + player.height > platform.y && player.y + player.height < platform.y + 20) {
                        player.y = platform.y - player.height; player.dy = 0; player.onGround = true;
                    }
                });

                let collectedCount = 0;
                coins.forEach(coin => {
                    if (!coin.collected && player.x < coin.x + coin.size && player.x + player.width > coin.x && player.y < coin.y + coin.size && player.y + player.height > coin.y) {
                        coin.collected = true; score += 10;
                    }
                    if (coin.collected) collectedCount++;
                });

                let defeatedEnemies = 0;
                enemies.forEach(enemy => {
                    if (enemy.alive) {
                        enemy.x += enemy.speed * enemy.direction;
                        if (enemy.x > enemy.startX + enemy.patrolRange || enemy.x < enemy.startX - enemy.patrolRange) enemy.direction *= -1;

                        if (player.x < enemy.x + enemy.width && player.x + player.width > enemy.x && player.y < enemy.y + enemy.height && player.y + player.height > enemy.y) {
                            if (player.dy > 0 && (player.y + player.height) < (enemy.y + 20)) {
                                enemy.alive = false; player.dy = -8; score += 100;
                            } else {
                                handleDeath();
                            }
                        }
                    } else {
                        defeatedEnemies++;
                    }
                });

                if (collectedCount === coins.length && defeatedEnemies === enemies.length) {
                    advanceStage();
                }

                if (player.x < 0) player.x = 0;
                if (player.x + player.width > canvas.width) player.x = canvas.width - player.width;
            }

            function updateShooter() {
                if (keys.left) rocket.x -= rocket.speed;
                if (keys.right) rocket.x += rocket.speed;
                if (rocket.x < 0) rocket.x = 0;
                if (rocket.x + rocket.width > canvas.width) rocket.x = canvas.width - rocket.width;

                if (shootCooldown > 0) shootCooldown--;
                if (keys.up && shootCooldown === 0) {
                    bullets.push({ x: rocket.x + rocket.width / 2 - 2.5, y: rocket.y, width: 5, height: 15, speed: 10 });
                    shootCooldown = 15;
                }

                bullets.forEach((b, i) => { b.y -= b.speed; if (b.y < 0) bullets.splice(i, 1); });

                if (Math.random() < 0.04) {
                    rocks.push({ x: Math.random() * (canvas.width - 50), y: -50, width: 50, height: 50, speed: 2 + Math.random() * 2 });
                }

                rocks.forEach((rock, rockIndex) => {
                    rock.y += rock.speed;
                    if (rock.y > canvas.height) rocks.splice(rockIndex, 1);

                    bullets.forEach((bullet, bulletIndex) => {
                        if (bullet.x < rock.x + rock.width && bullet.x + bullet.width > rock.x && bullet.y < rock.y + rock.height && bullet.y + bullet.height > rock.y) {
                            bullets.splice(bulletIndex, 1); rocks.splice(rockIndex, 1); score += 50; rocksDestroyed++;
                        }
                    });

                    if (rocket.x < rock.x + rock.width && rocket.x + rocket.width > rock.x && rocket.y < rock.y + rock.height && rocket.y + rocket.height > rock.y) {
                        handleDeath();
                    }
                });

                if (rocksDestroyed >= rocksToDestroy) {
                    advanceStage();
                }
            }

            // --- LÓGICAS DE DRAW ---
            function drawPlatformer() {
                ctx.fillStyle = '#87CEEB'; ctx.fillRect(0, 0, canvas.width, canvas.height);
                ctx.fillStyle = 'green'; ctx.fillRect(0, canvas.height - groundHeight, canvas.width, groundHeight);
                ctx.fillStyle = '#A0522D'; platforms.forEach(p => ctx.fillRect(p.x, p.y, p.width, p.height));
                ctx.fillStyle = 'gold';
                coins.forEach(c => {
                    if (!c.collected) { ctx.beginPath(); ctx.arc(c.x + c.size / 2, c.y + c.size / 2, c.size, 0, Math.PI * 2); ctx.fill(); }
                });
                enemies.forEach(e => { if (e.alive) { ctx.drawImage(enemyImage, e.x, e.y, e.width, e.height); } });
                ctx.drawImage(playerImage, player.x, player.y, player.width, player.height);
            }

            function drawShooter() {
                ctx.fillStyle = '#000020'; ctx.fillRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(rocketImage, rocket.x, rocket.y, rocket.width, rocket.height);
                ctx.fillStyle = 'grey'; rocks.forEach(r => ctx.fillRect(r.x, r.y, r.width, r.height));
                ctx.fillStyle = 'yellow'; bullets.forEach(b => ctx.fillRect(b.x, b.y, b.width, b.height));
            }

            function drawWinScreen() {
                ctx.fillStyle = '#000020';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                ctx.fillStyle = 'gold';
                ctx.font = '60px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('VOCÊ VENCEU!', canvas.width / 2, canvas.height / 2 - 40);
                ctx.font = '40px Arial';
                ctx.fillText(`Pontuação Final: ${score}`, canvas.width / 2, canvas.height / 2 + 40);
                ctx.textAlign = 'left';
            }

            // --- LOOP PRINCIPAL ---
            function gameLoop() {
                if (gameState === 'win') {
                    drawWinScreen();
                    requestAnimationFrame(gameLoop);
                    return;
                }

                if (gameState === 'platformer') { updatePlatformer(); } else { updateShooter(); }
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                if (gameState === 'platformer') { drawPlatformer(); } else { drawShooter(); }

                ctx.fillStyle = 'white'; ctx.font = '30px Arial';
                ctx.fillText(`Pontuação: ${score}`, 20, 40);
                ctx.fillText(`Vidas: ${lives}`, 20, 80);
                ctx.fillText(`Estágio: ${stage}`, canvas.width - 180, 40);
                if (gameState === 'shooter') { ctx.fillText(`Rochas: ${rocksDestroyed} / ${rocksToDestroy}`, canvas.width / 2 - 150, 40); }

                requestAnimationFrame(gameLoop);
            }

            // --- INÍCIO ---
            const allImages = [playerImage, rocketImage, enemyImage];
            let imagesLoaded = 0;
            function onImageLoad() {
                imagesLoaded++;
                if (imagesLoaded === allImages.length) {
                    generatePlatformerLevel();
                    gameLoop();
                }
            }
            allImages.forEach(img => {
                if (img.complete) {
                    onImageLoad();
                } else {
                    img.onload = onImageLoad;
                }
            });
        }
    </script>
</body>
</html>